import { Menu } from "antd"
import "./About.css"
import { useState } from "react"

const items = [
    {
        key: '1',
        label: 'Общая информация',
        type: 'group',
        children: [
            {key: '1.1', label: "О приложении", function: <AboutProgram/>},
            {key: '1.2', label: "Интерфейс и навигация", function: <InterfaceNavigation/>}
        ]
    },
    {
        key: '2',
        label: 'Работа с приложением',
        type: 'group',
        children: [
            {key: '2.1', label: 'Составление прогноза', function: <MakingForecast/>},
            {key: '2.2', label: 'Генерация TAF', function: <TafGeneration/>}
        ]
    },
    {
        key: '3',
        label: 'Система валидации',
        type: 'group',
        children: [
            {key: '3.1', label: 'Система валидации', function: <ValidationRules/>},
            {key: '3.2', label: 'Создание правил', function: <MakingRule/>}
        ]
    }
]

function AboutProgram() {
    return (
        <div>
            <h1>О приложении</h1>
            <p>Приложение создано для автоматизации двух ключевых задач:</p>
            <ol>
                <li>Составление прогноза TAF по введённым пользователем данным.</li>
                <li>Проверка данных и контроль выполнения правил оформления прогноза.</li>
            </ol>

            <p>Приложение объединяет несколько технологий:</p>
            <ul>
                <li>React и Vite — пользовательский интерфейс.</li>
                <li>Tauri — оболочка для десктопных приложений.</li>
                <li>Rust — внутренняя логика, генерация файлов и взаимодействие с системными функциями.</li>
                <li>JavaScript — логика интерфейса, валидация и обработка данных.</li>
                <li>TypeScript — ответсвенные модули, являющимися основой приложения.</li>
            </ul>

            <p>Исходный код открыт и распространяется по лицензии MIT. Вы можете свободно использовать, модифицировать и распространять приложение при условии сохранения уведомления об авторском праве и текста лицензии.</p>

            <p>
                Репозиторий проекта:{" "}
                <a href="https://github.com/IOreshin/meteo-taf-app">github.com/IOreshin/meteo-taf-app</a>
            </p>
            <p>
                Автор:{" "}
                <a href="https://github.com/IOreshin">IOreshin</a>
            </p>
        </div>
    );
}

function InterfaceNavigation() {
    return (
        <div>
            <h1>Интерфейс и навигация</h1>

            <p>Интерфейс приложения построен вокруг нескольких основных блоков:</p>

            <ul>
                <li><strong>Составление прогноза</strong> — основное рабочее пространство.</li>
                <li><strong>Управление условиями</strong> — список ошибок и предупреждений.</li>
                <li><strong>Справка</strong> — информация о приложении и способах работы с ним.</li>
            </ul>

            

            <h2>Составление прогноза</h2>
            <p>Вкладка Составление прогноза является основным рабочим пространством.</p>
            <p>На этой вкладке расположены формы для ввода исходных данных, инструменты для выбора облачности и явлений, предпросмотр TAF прогноза и зона со списком допущенных ошибок в прогнозе.</p>
            <p>Зоны прогноза и ошибок обновляется динамически: любое изменение сразу отражается в валидаторе и в предварительном результате.</p>
            
            <h2>Управление условиями</h2>
            <p>На вкладке Управление условиями можно как проверить текущие записанные правила для проверок, так и создать новые.</p>
            <p>Подробнее о создании правил в следующих разделах.</p>
        </div>
    );
}

function MakingForecast() {
    return (
        <div>
            <h1>Составление прогноза</h1>

            <h2>Общие условия</h2>
            <p>Общие условия — это базовый набор данных, на котором строится основной TAF.</p>
            <p>Для корректного формирования прогноза необходимо заполнить следующие поля:</p>

            <ul>
                <li><strong>ICAO</strong> — код аэродрома или города. Предлагаемые варианты находятся в <code>config/airports.json</code>. Вы можете дополнять этот файл своими данными.</li>
                <li><strong>Время выпуска (issue_time)</strong> — момент публикации прогноза в формате <code>DDHHMM</code>.</li>
                <li><strong>Время действия (time_from, time_to)</strong> — период, на который составляется прогноз, в формате <code>DDHH</code>.</li>
                <li><strong>Направление ветра (wind_dir)</strong> — направление в градусах (например, 270).</li>
                <li><strong>Скорость ветра (wind_speed)</strong> — средняя скорость в м/с.</li>
                <li><strong>Порыв ветра (wind_gust)</strong> — порыв в м/с. Можно не указывать, если его нет.</li>
                <li><strong>Видимость (visibility)</strong> — видимость в метрах.</li>
            </ul>

            <p>Эти данные формируют основной каркас прогноза, к которому затем добавляются облачность, явления и переходные группы.</p>

            <h2>Облачность</h2>
            <p>Для добавления информации об облачности нажмите «Добавить облачность». Появится строка с тремя полями:</p>
            <ol>
                <li>Тип облачности.</li>
                <li>Высота нижней границы.</li>
                <li>Характеристика (опционально).</li>
            </ol>
            <p>Вы можете использовать предложенные варианты или ввести свои значения. Количество уровней облачности не ограничено.</p>
            <p>Для удаления строки нажмите кнопку с корзиной справа.</p>

            <h2>Явления</h2>
            <p>Добавление явлений работает аналогично облачности. Каждая строка содержит:</p>
            <ol>
                <li>Интенсивность.</li>
                <li>Дескриптор.</li>
                <li>Код явления.</li>
            </ol>

            <p>Приложение поддерживает любое количество явлений. Каждый элемент можно удалять или изменять в любой момент.</p>
        </div>
    );
}

function TafGeneration() {
    return (
        <div>
            <h1>Генерация TAF</h1>
            <p>После заполнения всех данных приложение формирует финальный текст прогноза. Генерация происходит по установленным правилам и стандартам.</p>

            <h2>Этапы формирования</h2>
            <ol>
                <li>Сбор данных из всех разделов формы.</li>
                <li>Проверка на ошибки и предупреждения.</li>
                <li>Формирование основного блока прогноза.</li>
                <li>Добавление переходных групп (BECMG, TEMPO).</li>
                <li>Форматирование результата.</li>
            </ol>

            <h2>Особенности</h2>
            <ul>
                <li>Поля автоматически приводятся к нужному формату (дополняются нулями, сокращаются, нормализуются).</li>
                <li>Пустые и необязательные значения не включаются в прогноз.</li>
                <li>Облака и явления сортируются в соответствии со стандартом.</li>
                <li>Переходные группы вставляются в правильном порядке.</li>
            </ul>
        </div>
    );
}

function ValidationRules() {
    return (
        <div>
            <h1>Система правил и валидации</h1>
            <p>Приложение использует настраиваемый механизм проверки данных. Все правила находятся в файле <code>validation-rules.json</code>, а обработкой занимается модуль валидатора Validator.ts.</p>

            <h2>Структура правила</h2>
            <p>Правило состоит из:</p>
            <ul>
                <li><strong>code</strong> — уникальный идентификатор правила или комбинации явлений.</li>
                <li><strong>rules</strong> — список логических условий.</li>
                <li><strong>message</strong> — текст ошибки, который будет показан пользователю.</li>
            </ul>

            <p>Логическое выражение строится как:</p>
            <pre>left_operand / operator / right_operand</pre>

            <p>В качестве оператора могут использоваться сравнения, проверка пустоты, диапазоны и другие базовые операции.</p>

            <h2>Как работает валидация</h2>
            <p>Валидатор запускается при любом изменении данных. Он проходит по исходным данным, сопоставляет их с правилами и выводит сообщения об ошибках.</p>
            <p>Проверяются:</p>
            <ul>
                <li>формат и корректность значений;</li>
                <li>логические связи между параметрами (например, порыв не может быть меньше средней скорости);</li>
                <li>комбинации явлений (например, при определенном коде являния одно из базовых показателей не может превышать определенное значение);</li>
                <li>наличие противоречий.</li>
            </ul>

            <p>Все найденные ошибки отображаются в списке под формой прогноза.</p>
        </div>
    );
}

export function MakingRule() {
  return (
    <div>
        <h1>Создание правила в редакторе</h1>

        <p>
            Этот раздел объясняет, как последовательно создавать правило проверки
            данных в приложении. Правило состоит из сообщения и одного или нескольких
            логических блоков. Каждый блок сравнивает левую и правую части и при
            выполнении логического выражения может привести к срабатыванию сообщения.
        </p>

        <h2>Коротко — структура правила</h2>
        <p>
            Правило содержит:
        </p>
        <ul>
            <li><strong>message</strong> — текст, который увидит пользователь при срабатывании.</li>
            <li><strong>conditions</strong> — массив блоков условий. Каждый блок — одна проверка.</li>
            <li><strong>logic_link</strong> в каждом блоке — связь с предыдущим блоком: <code>None</code>, <code>AND</code>, <code>OR</code>.</li>
        </ul>

        <strong>Основная философия проверок - нужно указать такие условия, выполнение которых приведет к ошибке.</strong>


        <h2>Интерфейс</h2>

        <h3>Тип правила</h3>
        <p>
            Вверху выбирается тип правила:
        </p>
        <ul>
            <li><strong>Общее правило</strong> — применяется всегда и проверяет текущие данные.</li>
            <li><strong>Правило по коду</strong> — срабатывает только если в прогнозе присутствует выбранный код явления (например <code>-RA</code>, <code>FG</code>, <code>+SN</code>).</li>
        </ul>

        <h3>Код явления</h3>
        <p>
            Для правил по коду введите или выберите код в поле. Подсказки формируются из комбинаций интенсивности, дескриптора и кода явления.
        </p>

        <h3>Сообщение об ошибке</h3>
        <p>
            В поле «Сообщение об ошибке» укажите понятный текст, который увидит пользователь при нарушении правила.
        </p>

        <h2>Блок условия — поля и опции</h2>
        <p>Каждый блок содержит следующие элементы:</p>
        <ul>
            <li><strong>Поле</strong> — параметр, к которому применяется проверка (выпадающий список с описаниями).</li>
            <li><strong>Функция</strong> — опциональная функция над полем (например, <code>exists(x)</code>, <code>to_int(x)</code>).</li>
            <li><strong>Expr слева</strong> — альтернативное выражение для левой части (можно ввести формулу: <code>field + 5</code>, <code>to_int(field) * 2</code> и т.д.).</li>
            <li><strong>Оператор</strong> — один из: <code>==, !=, &lt;, &gt;, &lt;=, &gt;=</code>. (Не показывается для <code>exists(x)</code>.)</li>
            <li><strong>Значение / Поле справа</strong> — справа можно указать константу, выбрать другое поле или ввести выражение (Expr справа).</li>
            <li><strong>Значение — поле</strong> — переключатель, который превращает правую часть в ссылку на другое поле.</li>
            <li><strong>Expr справа</strong> — если нужно использовать формулу справа (например <code>field / 100</code>).</li>
        </ul>
        <p>
            Во многих случаях при проверке если происходит числовая проверка, то 
            в качестве функции стоит использовать to_int. Это функция приведет введенное
            в поле значение к целому числу и ,например, не будет учитывать случайно введенный текст
        </p>
        

        <h2>Логические связи между блоками</h2>
        <p>
            Первому блоку присваивается <code>logic_link: "None"</code>. Для добавляемых блоков нужно выбрать,
            как их связать с предыдущими: <code>AND</code> или <code>OR</code>. Интерпретация стандартная:
        </p>
        <ul>
            <li><code>AND</code> — все связанные блоки должны быть истинны.</li>
            <li><code>OR</code> — достаточно истинности любого из связанных блоков.</li>
        </ul>

        <h2>Примеры правил</h2>

        <h3>Пример 1 — простая проверка значения</h3>
        <p>Задача: показать ошибку, если видимость больше 800 м.</p>
        <p>Параметры:</p>
        <ul>
            <li>Поле: <code>Видимость</code></li>
            <li>Функция: <code>to_int(x)</code></li>
            <li>Оператор: <code>&gt;</code></li>
            <li>Значение: <code>800</code></li>
            <li>message: «Видимость выше допустимой»</li>
        </ul>

        <p>
            В таком случае, когда в поле Видимость будет введено значение 
            видимости <strong>больше</strong>, чем 800, то вызовется ошибка.
        </p>

        <h3>Пример 2 — сравнение двух полей</h3>
        <p>Задача: проверять, что средняя скорость меньше скорости порыва</p>
        <p>Параметры:</p>
        <ul>
            <li>Поле слева: <code>Скорость ветра</code></li>
            <li>Оператор: <code>&gt;</code></li>
            <li>Значение справа: выбрать поле <code>Порыв ветра</code> (включить «Значение — поле»)</li>
            <li>message: Значение порыва ветра должно быть больше скорости ветра</li>
        </ul>
        <p>
            В таком случае, когда порыв ветра будет меньше по значению, чем скорость ветра появится ошибка.
        </p>

        <h3>Пример 3 — сложное условие с двумя блоками</h3>
        <p>Задача: показать ошибку, если видимость &lt; 2000 и скорость ветра &gt; 15 м/с.</p>
        <p>Параметры:</p>
        <ol>
            <li>Первый блок:</li>
                <ul>
                    <li>Поле слева: <code>Видимость</code></li>
                    <li>Оператор: <code>&lt;</code></li>
                    <li>Значение: <code>2000</code></li>
                </ul>
            <li>Создать связь AND, т.к. условия должны выполняться одновременно</li>
            <li>Второй блок:</li>
                <ul>
                    <li>Поле слева: <code>Скорость ветра</code></li>
                    <li>Оператор: <code>&gt;</code></li>
                    <li>Значение: <code>15</code></li>
                </ul>
            <li>message: Скорость ветра не должна превышать 15 MPS при видимости меньше 2000</li>
        </ol>

        <p>
            В таком случае, когда скорость ветра будет больше 15 м/с, а видимость будет указана меньше 2000,
            то будет отображена ошибка.
        </p>


        <h2>Как интерпретируются выражения (Expr)</h2>
        <p>
            В полях <code>expr</code> допускаются простые арифметические выражения, где
            идентификатор <code>field</code> обозначает текущее выбранное поле.
            Примеры:
        </p>
        <ul>
            <li><code>field + 5</code> — значение поля + 5</li>
            <li><code>to_int(field) * 2</code> — сначала приведение к целому, затем умножение</li>
            <li><code>field / 100</code> — деление на 100</li>
        </ul>
        <p>
            Если в блоке задана функция (например, <code>to_int</code>) и выражение
            пусто, функция применяется к значению поля автоматически.
        </p>
        <p>
            При формировании выражения <strong>ОБЯЗАТЕЛЬНО</strong> использовать <code>field</code> как переменную,
            место которой займет указанное в Поле значение. Иначе валидатор не сможет обработать такую проверку.
        </p>

        <h2>Сохранение правила</h2>
        <p>
            Нажмите кнопку <strong>Сохранить правило</strong>. Правило будет отправлено
            в бекенд и сохранено в конфигурации. После сохранения приложение пометит
            данные для перезагрузки и сбросит форму редактора.
        </p>

        <h2>Рекомендации и частые ошибки</h2>
        <ul>
            <li>В подавляющем большинстве случаев указывайте функцию <code>to_int(x)</code> для значения. Это сделает проверку более предсказуемой и надежной</li>
            <li>Проверяйте, что имена полей совпадают с доступными в выпадающем списке.</li>
            <li>Если используете <code>exists(x)</code>, оператор указывать не нужно.</li>
            <li>При сравнении полей не забывайте включить «Значение — поле» и выбрать правое поле.</li>
            <li>При вводе выражений используйте корректный синтаксис: операторы <code>+ - * /</code> и идентификатор <code>field</code>.</li>
            <li>Проверяйте сообщения — формулируйте так, чтобы пользователь понял, что нужно исправить.</li>
        </ul>
    </div>
  );
}

export function About() {
    const [selectedKey, setSelectedKey] = useState("1.1");

    const onMenuClick = e => {
        setSelectedKey(e.key);
    }

    const findItemByKey = (key) => {
        for (const group of items) {
            if (group.children) {
                const found = group.children.find(ch => ch.key === key);
                if (found) return found;
            }
        }
        return null;
    };

    const selectedItem = findItemByKey(selectedKey);

    return (
        <div style={{display: "flex", flexDirection:"row", height: "100%"}}>
            <div style={{display: "flex", height: "100%"}}>
                <Menu
                    onClick={(e) => onMenuClick(e)}
                    style={{width: "225px", height: "100%"}}
                    defaultSelectedKeys={['1.1']}
                    mode="inline"
                    items={items}
                />
            </div>
            <div className="about-page">
                {selectedItem?.function ?? <div>Выберите пункт меню</div>}
            </div>
        </div>
    )
}

